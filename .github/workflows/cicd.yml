name: Java 8 CI/CD (GHCR + GitOps + ArgoCD)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/de-butler/knot-bbf-app
  GITOPS_REPO: KimRua/homelab-gitops
  GITOPS_KUSTOMIZATION_FILE: clusters/home/apps/knot-bbf-app/kustomization.yaml

jobs:
  build_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: "8"
          distribution: "temurin"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ✅ PR에서는 테스트 포함 권장 / 원하면 -x test 유지 가능
      - name: Build with Gradle
        run: ./gradlew clean build --no-daemon

  docker_and_gitops:
    needs: build_test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ✅ sha 태그로 pin + (선택) latest도 같이
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ----------------------------
      # ✅ GitOps repo 직접 push (B안)
      # ----------------------------
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_TOKEN }}
          path: gitops

      - name: Update kustomization image tag
        run: |
          set -euo pipefail
          FILE="gitops/${GITOPS_KUSTOMIZATION_FILE}"
          NEW_TAG="sha-${GITHUB_SHA}"

          if [ ! -f "$FILE" ]; then
            echo "ERROR: kustomization file not found: $FILE"
            echo "Hint: check GitOps path and filename"
            exit 1
          fi

          # newTag 라인 교체
          sed -i "s/^\([[:space:]]*newTag:[[:space:]]*\).*/\1${NEW_TAG}/" "$FILE"

          echo "Updated $FILE => newTag: ${NEW_TAG}"
          git -C gitops diff

      - name: Commit & push to GitOps repo
        run: |
          set -euo pipefail
          git -C gitops config user.name  "gitops-bot"
          git -C gitops config user.email "gitops-bot@users.noreply.github.com"

          if git -C gitops diff --quiet; then
            echo "No changes. Skip commit."
            exit 0
          fi

          git -C gitops add "${GITOPS_KUSTOMIZATION_FILE}"
          git -C gitops commit -m "chore(knot-bbf-app): bump image to sha-${GITHUB_SHA}"
          git -C gitops push